<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多圖片上傳預覽</title>
    <style>
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .image-preview {
            position: relative;
            width: 200px;
            height: 200px;
            border: 1px solid #ddd;
            margin: 5px;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }
        .btn {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        #upload-btn {
            background-color: #4CAF50;
        }
        #upload-btn:hover {
            background-color: #45a049;
        }
        #submit-btn {
            background-color: #2196F3;
        }
        #submit-btn:hover {
            background-color: #1976D2;
        }
        #file-input {
            display: none;
        }
        .button-container {
            margin: 20px 0;
        }
        .upload-status {
            color: #4CAF50;
            margin-left: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <form id="upload-form" method="POST" enctype="multipart/form-data">
        <div class="button-container">
            <input type="file" id="file-input" multiple accept="image/*">
            <button type="button" id="upload-btn" class="btn">選擇圖片</button>
            <button type="submit" id="submit-btn" class="btn">送出</button>
            <span id="upload-status" class="upload-status"></span>
        </div>
        <div class="preview-container" id="preview-container"></div>
    </form>

    <script>
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const previewContainer = document.getElementById('preview-container');
        const uploadForm = document.getElementById('upload-form');
        const uploadStatus = document.getElementById('upload-status');
        let uploadedImages = [];

        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        addImagePreview(e.target.result, file);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            // 清空 input 值，這樣同樣的檔案可以再次選擇
            fileInput.value = '';
        });

        function addImagePreview(imageSrc, file) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            
            const img = document.createElement('img');
            img.src = imageSrc;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = 'X';
            deleteBtn.onclick = function() {
                previewDiv.remove();
                // 從已上傳圖片陣列中移除
                const index = uploadedImages.findIndex(img => img.src === imageSrc);
                if (index > -1) {
                    uploadedImages.splice(index, 1);
                }
            };
            
            previewDiv.appendChild(img);
            previewDiv.appendChild(deleteBtn);
            previewContainer.appendChild(previewDiv);

            // 將圖片資訊加入已上傳陣列
            uploadedImages.push({
                src: imageSrc,
                file: file
            });
        }

        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const newFiles = Array.from(fileInput.files);
            
            if (uploadedImages.length === 0) {
                alert('請選擇至少一張圖片！');
                return;
            }

            uploadedImages.forEach((image, index) => {
                if (image.file) {
                    formData.append(`images`, image.file);
                }
            });

            try {
                uploadStatus.textContent = '上傳中...';
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    uploadStatus.textContent = '上傳成功！';
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 3000);
                    
                    // 清空文件選擇，但保留預覽
                    fileInput.value = '';
                    // 標記所有圖片為已上傳（清除 file 引用）
                    uploadedImages.forEach(image => {
                        image.file = null;
                    });
                } else {
                    uploadStatus.textContent = '上傳失敗，請重試。';
                }
            } catch (error) {
                console.error('上傳錯誤：', error);
                uploadStatus.textContent = '上傳發生錯誤，請重試。';
            }
        });
    </script>
</body>
</html>